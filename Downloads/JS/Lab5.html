<!DOCTYPE html>
<html>
  <head>
    <link rel="icon" type="image/png" sizes="16x16" href="ICO/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="ICO/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="32x32" href="ICO/favicon-96x96.png">
    <link rel="apple-touch-icon" sizes="180x180" href="ICO/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="ICO/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="ICO/android-chrome-512x512.png">

  </head>
  <body>

    <ul id="chat-messages"></ul>

    <script type="application/javascript">

// Función para detectar y crear vista previa de enlaces a imágenes
      function createImagePreview(message) {
        const imageRegex = /(http(s?):)([/|.|\w|\s|-])*\.(?:jpg|gif|png)/g; // Expresión regular para enlaces a imágenes
        
        const matches = message.match(imageRegex);
        if (matches) {
          matches.forEach(match => {
            const img = new Image(); // Crear un nuevo elemento de imagen
            img.src = match;
            img.alt = 'Image Preview';
            
            const li = document.createElement('li');
            li.appendChild(img);
            
            document.getElementById('chat-messages').appendChild(li);
          });
        }
      }
      
      // Función para detectar y crear vista previa de enlaces a páginas web
      function createWebPreview(message) {
        const webRegex = /https?:\/\/(?:www\.|(?!www))[^\s\.]+\.[^\s]{2,}|www\.[^\s]+\.[^\s]{2,}/g; // Expresión regular para enlaces a páginas web
        
        const matches = message.match(webRegex);
        if (matches) {
          matches.forEach(match => {
            const a = document.createElement('a');
            a.href = match;
            a.textContent = match;
            a.target = '_blank';
            
            const li = document.createElement('li');
            li.appendChild(a);
            
            document.getElementById('chat-messages').appendChild(li);
          });
        }
      }
      
      // Función para agregar un mensaje al chat con vistas previas de enlaces
      function addMessage(username, message) {
        const li = document.createElement('li');
        li.textContent = `${username}: ${message}`;
        
        createImagePreview(message);
        createWebPreview(message);
        
        document.getElementById('chat-messages').appendChild(li);
      }

      const ul = document.createElement('ul')
      document.body.append(ul)

      const t = document.createElement('textarea')
      t.setAttribute('maxlength', '140'); // Limitar a 140 caracteres
      document.body.append(t)
      
      const charCount = document.createElement('div');
      charCount.innerText = '0/140';
      document.body.append(charCount);

      const b = document.createElement('button')
      b.append('SEND')
      document.body.append(b)


      const getMessages = async () => {
        const response = await fetch('https://chat.tiburoncin.lat/messages')
        const messages = await response.json()
        
        messages.forEach((message) => {
          const li = document.createElement('li')
          li.append(`${message.username}: ${message.message}`)
          ul.append(li)
        })
      }

      const postMessage = async () => {
        const message = t.value.trim(); 
        if (message.length > 0) {
          const body = {
            username: 'an',
            message: message,
          }
          const response = await fetch('https://chat.tiburoncin.lat/messages', {
            method: 'POST',
            body: JSON.stringify(body)
          })
          ul.innerHTML = ""
          getMessages()
          t.value = ""; // Borrar contenido luego de enviar mensaje
          charCount.innerText = '0/140'; 
        }
      }

      b.addEventListener('click', postMessage);

      t.addEventListener('input', () => {
        charCount.innerText = `${t.value.length}/140`;
      });

      getMessages()
    </script>
  </body>
</html>
